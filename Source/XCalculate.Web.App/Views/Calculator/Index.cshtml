@model CalculatorIndexModel

@{
    ViewData["Title"] = @Model.Name;
}

@*@Html.AntiForgeryToken()*@

<h2>@Model.Name - @Model.Id</h2>
<p>@Model.Description</p>
<p>
    <ul>
        @foreach (var tag in Model.Tags)
        {
            <li>@tag</li>
        }
    </ul>
</p>
<div id="calculator-input-group">
    @for (var i = 0; i < Model.Inputs.Length; i++)
    {
        var label = Model.Inputs[i].ValueLabel.Replace(" ", string.Empty);
        if (Model.Inputs[i].IsArray)
        {
            <div id="array-input-group-@label">
                <div id="array-input-group-@label-@i" class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">@Model.Inputs[i].ValueLabel</span>
                    </div>
                    <input type="text" class="form-control" id="input-@label-@i" oninput="onInputValue(this);">
                    <div id="array-value-button-@label-@i" class="input-group-append">
                        <button class="btn btn-outline-secondary" type="button" onclick="onClickInputValueButton(this);">+</button>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div id="input-group-@label" class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text" id="basic-addon3">@label</span>
                </div>
                <input type="text" class="form-control" id="input-@label" oninput="onInputValue(this);">
            </div>
        }
    }
</div>
<p>
    <input type="button" class="btn" value="Calculate" onclick="onClickSubmit();" />
</p>
<div id="calculator-result-group">
    @for(var i = 0; i < Model.Results.Length; i++)
    {
        var label = Model.Results[i].ValueLabel.Replace(" ", string.Empty);
        <div class="input-group mb-3">
            @if (Model.Results[i].ValueLabel != null && Model.Results[i].ValueLabel.Length > 0)
            {
                <div class="input-group-prepend">
                    <span class="input-group-text">@Model.Results[i].ValueLabel</span>
                </div>
            }
            <input type="text" id="calculator-result-@label" class="form-control mr-sm-2" readonly />
            @if (Model.Results[i].UnitLabel != null && Model.Results[i].UnitLabel.Length > 0)
            {
                <div class="input-group-append">
                    <span class="input-group-text">@Model.Results[i].UnitLabel</span>
                </div>
            }
        </div>
    }
</div>

<script type="text/javascript">
    var inputs = {};
    var arrayInputs = {};

    function onClickSubmit() {
        var url = "/Calculator/@Model.Id/Calculate";
        $.ajax({
            url: url,
            type: "POST",
            contentType: "application/json",
            headers: {
                //RequestVerificationToken:
                //    $('input:hidden[name="__RequestVerificationToken"]').val()
            },
            data: JSON.stringify({ inputs: inputs, arrayInputs: arrayInputs })
        })
        .done(function (result) {
            for (var i = 0; i < result.results.length; i++) {
                var label = result.results[i].info.name.replace(/ /g, "");
                $("#calculator-result-" + label).val(result.results[i].value);
            }
        });
    }

    function onInputValue(e) {
        var id = $(e).attr("id");
        var parts = id.split("-");
        var valueName = parts[1];
        var value = $(e).val().toString();

        if (parts.length > 2) {
            var index = parseInt(parts[2]);
            if (!arrayInputs[valueName]) {
                arrayInputs[valueName] = [];
            }

            if (arrayInputs[valueName][index]) {
                arrayInputs[valueName][index] = value;
            }
            else {
                arrayInputs[valueName].push(value);
            }
        }
        else {
            inputs[valueName] = value;
        }
    }

    function onClickInputValueButton(e) {
        var $appendGroup = $(e).parent();
        var $valueInputGroup = $appendGroup.parent();
        var $inputGroup = $valueInputGroup.parent();

        if (e.innerText === "+") {
            e.innerText = "-";

            var $clone = $valueInputGroup.clone(true, true);
            $button = $clone.find("button");
            $button.text("+");
            var $input = $clone.find("input");
            $input.attr("id", incrementId($input.attr("id")));
            $clone.attr("id", incrementId($clone.attr("id")));
            $input.val("");

            $clone.appendTo($inputGroup);
        }
        else if (e.innerText === "-") {
            var id = $valueInputGroup.attr("id");
            var parts = id.split("-");
            var index = parseInt(parts[parts.length - 1]);
            var valueName = parts[parts.length - 2];
            arrayInputs[valueName].splice(index, 1);
            $valueInputGroup.remove();
        }
        else {
            console.log("Unknown array input button text.");
        }
    }

    function incrementId(id) {
        var parts = id.split("-");
        parts[parts.length - 1] = (parseInt(parts[parts.length - 1]) + 1).toString();
        var newId = "";
        for (var i = 0; i < parts.length; i++) {
            if (i != 0) {
                newId += "-";
            }
            newId += parts[i];
        }
        return newId;
    }
</script>
